<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>לוח משמרות</title>
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,1,0" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.2/html2pdf.bundle.min.js"></script>
    <style>
        :root {
            --blue: #3b82f6;
            --blue-dark: #2563eb;
            --blue-light: #dbeafe;
            --purple: #8b5cf6;
            --purple-dark: #7c3aed;
            --purple-light: #ede9fe;
            --slate-50: #f8fafc;
            --slate-100: #f1f5f9;
            --slate-200: #e2e8f0;
            --slate-300: #cbd5e1;
            --slate-400: #94a3b8;
            --slate-500: #64748b;
            --slate-600: #475569;
            --slate-700: #334155;
            --slate-800: #1e293b;
            --slate-900: #0f172a;
            --red: #ef4444;
            --red-light: #fee2e2;
            --green: #22c55e;
            --green-light: #dcfce7;
            --amber: #f59e0b;
            --radius: 16px;
            --radius-sm: 10px;
            --radius-xs: 6px;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.06), 0 1px 2px rgba(0,0,0,0.04);
            --shadow: 0 4px 24px rgba(0,0,0,0.06), 0 1px 4px rgba(0,0,0,0.04);
            --shadow-lg: 0 10px 40px rgba(0,0,0,0.08), 0 2px 8px rgba(0,0,0,0.04);
            --transition: 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Heebo', sans-serif;
            background: linear-gradient(135deg, #667eea08 0%, #764ba208 100%), var(--slate-50);
            min-height: 100vh;
            color: var(--slate-800);
            padding: 24px 16px 80px;
        }

        .material-symbols-rounded {
            font-variation-settings: 'FILL' 1, 'wght' 500, 'GRAD' 0, 'opsz' 24;
            vertical-align: middle;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
        }

        /* ── Header ── */
        .header {
            text-align: center;
            margin-bottom: 32px;
            animation: fadeDown 0.5s ease;
        }

        .header-icon {
            width: 56px; height: 56px;
            background: linear-gradient(135deg, var(--blue) 0%, var(--purple) 100%);
            border-radius: 16px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 12px;
            box-shadow: 0 8px 24px rgba(99, 102, 241, 0.3);
        }
        .header-icon .material-symbols-rounded { font-size: 28px; color: #fff; }

        h1 {
            font-size: 2rem;
            font-weight: 900;
            background: linear-gradient(135deg, var(--slate-800) 0%, var(--slate-600) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header-sub {
            font-size: 0.9rem;
            color: var(--slate-400);
            font-weight: 500;
            margin-top: 4px;
        }

        .sync-badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            margin-top: 8px;
            padding: 4px 14px;
            border-radius: 20px;
            font-size: 0.72rem;
            font-weight: 700;
            background: var(--green-light);
            color: var(--green);
        }

        /* ── Cards ── */
        .card {
            background: #fff;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 28px;
            margin-bottom: 24px;
            border: 1px solid rgba(0,0,0,0.04);
            animation: fadeUp 0.5s ease;
        }

        .card-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
        }

        .card-icon {
            width: 40px; height: 40px;
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        .card-icon .material-symbols-rounded { font-size: 22px; color: #fff; }
        .card-icon.blue { background: linear-gradient(135deg, var(--blue) 0%, #6366f1 100%); }
        .card-icon.green { background: linear-gradient(135deg, var(--green) 0%, #14b8a6 100%); }
        .card-icon.purple { background: linear-gradient(135deg, var(--purple) 0%, #ec4899 100%); }

        .card h2 {
            font-size: 1.15rem;
            font-weight: 800;
            color: var(--slate-800);
        }
        .card h2 small {
            display: block;
            font-size: 0.78rem;
            font-weight: 500;
            color: var(--slate-400);
            margin-top: 2px;
        }

        /* ── Schedule Table ── */
        .table-container {
            overflow-x: auto;
            border-radius: var(--radius-sm);
            border: 1px solid var(--slate-200);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 640px;
        }

        thead th {
            background: var(--slate-800);
            color: #fff;
            padding: 14px 8px;
            font-weight: 700;
            font-size: 0.85rem;
            text-align: center;
            letter-spacing: 0.3px;
        }
        thead th:first-child {
            text-align: right;
            padding-right: 18px;
            width: 90px;
            border-radius: 0 var(--radius-sm) 0 0;
        }
        thead th:last-child {
            border-radius: var(--radius-sm) 0 0 0;
        }

        tbody tr { transition: background var(--transition); }
        tbody tr:hover { filter: brightness(0.97); }

        tbody tr.row-morning { background: linear-gradient(90deg, #eff6ff 0%, #f8faff 100%); }
        tbody tr.row-evening { background: linear-gradient(90deg, #f5f3ff 0%, #faf8ff 100%); }
        tbody tr.row-morning + tr.row-evening { border-top: 2px solid var(--slate-200); }

        td {
            padding: 14px 8px;
            text-align: center;
            vertical-align: top;
        }
        td:first-child {
            text-align: right;
            padding-right: 18px;
            vertical-align: middle;
        }

        .shift-label {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        .shift-label-title {
            font-weight: 800;
            font-size: 0.9rem;
        }
        .shift-label-title.morning { color: var(--blue-dark); }
        .shift-label-title.evening { color: var(--purple-dark); }

        .shift-label-time {
            font-size: 0.7rem;
            font-weight: 600;
            color: var(--slate-400);
        }
        .shift-label-max {
            font-size: 0.65rem;
            font-weight: 600;
            color: var(--slate-300);
        }

        .names-cell { display: flex; flex-direction: column; align-items: center; gap: 4px; }

        .name-tag {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 700;
            color: #fff;
            white-space: nowrap;
            animation: popIn 0.3s ease;
        }
        .name-tag-m {
            background: linear-gradient(135deg, var(--blue) 0%, #6366f1 100%);
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
        }
        .name-tag-e {
            background: linear-gradient(135deg, var(--purple) 0%, #a855f7 100%);
            box-shadow: 0 2px 8px rgba(139, 92, 246, 0.3);
        }

        .empty-cell {
            color: var(--slate-300);
            font-size: 0.75rem;
            font-weight: 500;
        }

        /* ── Legend ── */
        .legend {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-top: 16px;
            flex-wrap: wrap;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.8rem;
            color: var(--slate-500);
            font-weight: 600;
        }
        .legend-dot {
            width: 12px; height: 12px;
            border-radius: 50%;
        }
        .legend-dot.morning { background: linear-gradient(135deg, var(--blue) 0%, #6366f1 100%); }
        .legend-dot.evening { background: linear-gradient(135deg, var(--purple) 0%, #a855f7 100%); }

        /* ── Build Button ── */
        .table-actions {
            display: flex;
            gap: 10px;
            margin-top: 16px;
        }
        @media (max-width: 700px) {
            .table-actions { flex-direction: column; }
        }

        .build-btn, .pdf-btn, .reset-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            flex: 1;
            padding: 14px;
            color: #fff;
            border: none;
            border-radius: var(--radius-sm);
            font-family: 'Heebo', sans-serif;
            font-size: 0.95rem;
            font-weight: 700;
            cursor: pointer;
            transition: all var(--transition);
        }

        .build-btn {
            background: linear-gradient(135deg, var(--slate-800) 0%, var(--slate-700) 100%);
            box-shadow: 0 4px 16px rgba(15, 23, 42, 0.2);
        }
        .build-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(15, 23, 42, 0.3);
        }
        .build-btn:active { transform: translateY(0); }
        .build-btn .material-symbols-rounded { font-size: 20px; }

        .pdf-btn {
            background: linear-gradient(135deg, var(--green) 0%, #14b8a6 100%);
            box-shadow: 0 4px 16px rgba(34, 197, 94, 0.3);
        }
        .pdf-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(34, 197, 94, 0.4);
        }
        .pdf-btn:active { transform: translateY(0); }
        .pdf-btn .material-symbols-rounded { font-size: 20px; }

        .reset-btn {
            background: linear-gradient(135deg, var(--red) 0%, #dc2626 100%);
            box-shadow: 0 4px 16px rgba(239, 68, 68, 0.3);
        }
        .reset-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(239, 68, 68, 0.4);
        }
        .reset-btn:active { transform: translateY(0); }
        .reset-btn .material-symbols-rounded { font-size: 20px; }

        /* ── Form ── */
        .form-section { position: relative; }

        .form-row {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
        }
        .form-row label {
            font-weight: 700;
            font-size: 0.88rem;
            color: var(--slate-600);
            min-width: 45px;
        }

        .input-wrap {
            flex: 1;
            position: relative;
        }

        .input-wrap input[type="text"] {
            width: 100%;
            padding: 12px 16px;
            padding-right: 44px;
            border: 2px solid var(--slate-200);
            border-radius: var(--radius-sm);
            font-family: 'Heebo', sans-serif;
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--slate-800);
            outline: none;
            transition: all var(--transition);
            background: var(--slate-50);
        }
        .input-wrap input:focus {
            border-color: var(--blue);
            background: #fff;
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
        }
        .input-wrap input:disabled {
            background: var(--slate-100);
            color: var(--slate-500);
        }

        .input-icon {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--slate-400);
        }
        .input-icon .material-symbols-rounded { font-size: 20px; }

        /* ── Days Grid ── */
        .days-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
            margin-bottom: 20px;
        }

        .day-col {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
        }
        .day-label {
            font-weight: 700;
            font-size: 0.78rem;
            color: var(--slate-700);
            background: var(--slate-100);
            width: 100%;
            text-align: center;
            padding: 8px 0;
            border-radius: var(--radius-xs);
            letter-spacing: 0.5px;
        }
        .shift-btns {
            display: flex;
            flex-direction: column;
            gap: 4px;
            width: 100%;
        }

        .shift-btn {
            width: 100%;
            padding: 10px 0;
            border: 2px solid var(--slate-200);
            border-radius: var(--radius-xs);
            background: #fff;
            font-family: 'Heebo', sans-serif;
            font-weight: 700;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all var(--transition);
            color: var(--slate-400);
            position: relative;
            overflow: hidden;
        }
        .shift-btn:hover {
            border-color: var(--slate-300);
            color: var(--slate-500);
        }

        .shift-btn.active-m {
            background: linear-gradient(135deg, var(--blue) 0%, #6366f1 100%);
            color: #fff;
            border-color: transparent;
            box-shadow: 0 3px 10px rgba(59, 130, 246, 0.3);
            transform: scale(1.02);
        }
        .shift-btn.active-e {
            background: linear-gradient(135deg, var(--purple) 0%, #a855f7 100%);
            color: #fff;
            border-color: transparent;
            box-shadow: 0 3px 10px rgba(139, 92, 246, 0.3);
            transform: scale(1.02);
        }

        .submit-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, var(--blue) 0%, #6366f1 100%);
            color: #fff;
            border: none;
            border-radius: var(--radius-sm);
            font-family: 'Heebo', sans-serif;
            font-size: 1rem;
            font-weight: 800;
            cursor: pointer;
            transition: all var(--transition);
            box-shadow: 0 4px 16px rgba(59, 130, 246, 0.3);
        }
        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 28px rgba(59, 130, 246, 0.4);
        }
        .submit-btn:active { transform: translateY(0); }
        .submit-btn .material-symbols-rounded { font-size: 20px; }

        .submit-btn.edit-mode {
            background: linear-gradient(135deg, var(--amber) 0%, #f97316 100%);
            box-shadow: 0 4px 16px rgba(245, 158, 11, 0.3);
        }
        .submit-btn.edit-mode:hover {
            box-shadow: 0 8px 28px rgba(245, 158, 11, 0.4);
        }

        .cancel-btn {
            display: none;
            align-items: center;
            justify-content: center;
            gap: 6px;
            width: 100%;
            padding: 12px;
            margin-top: 8px;
            background: transparent;
            color: var(--slate-500);
            border: 2px solid var(--slate-200);
            border-radius: var(--radius-sm);
            font-family: 'Heebo', sans-serif;
            font-size: 0.9rem;
            font-weight: 700;
            cursor: pointer;
            transition: all var(--transition);
        }
        .cancel-btn:hover {
            background: var(--slate-50);
            border-color: var(--slate-300);
        }
        .cancel-btn.visible { display: flex; }

        /* ── Employee Cards ── */
        .emp-list { display: flex; flex-direction: column; gap: 10px; }

        .emp-card {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 16px 20px;
            border-radius: var(--radius-sm);
            border: 1.5px solid var(--slate-200);
            background: #fff;
            transition: all var(--transition);
            flex-wrap: wrap;
            animation: fadeUp 0.3s ease;
        }
        .emp-card:hover {
            border-color: var(--blue);
            box-shadow: 0 4px 16px rgba(59, 130, 246, 0.08);
            transform: translateY(-1px);
        }

        .emp-avatar {
            width: 40px; height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--blue-light) 0%, var(--purple-light) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            font-size: 0.95rem;
            color: var(--blue-dark);
            flex-shrink: 0;
        }

        .emp-info { flex: 1; min-width: 0; }
        .emp-name {
            font-weight: 800;
            font-size: 1rem;
            color: var(--slate-800);
            margin-bottom: 2px;
        }
        .emp-meta {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.75rem;
            color: var(--slate-400);
            font-weight: 600;
        }

        .emp-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 10px;
            border-radius: 20px;
            font-size: 0.72rem;
            font-weight: 700;
            background: var(--slate-100);
            color: var(--slate-600);
        }

        .emp-shifts {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
        }

        .emp-shift-tag {
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 0.68rem;
            font-weight: 700;
            color: #fff;
        }
        .emp-shift-tag.m {
            background: linear-gradient(135deg, var(--blue) 0%, #6366f1 100%);
        }
        .emp-shift-tag.e {
            background: linear-gradient(135deg, var(--purple) 0%, #a855f7 100%);
        }
        .emp-shift-tag.overflow {
            background: linear-gradient(135deg, #f59e0b 0%, #eab308 100%);
            color: #78350f;
        }

        .emp-actions { display: flex; gap: 6px; margin-right: auto; }

        .btn-icon {
            width: 36px; height: 36px;
            border-radius: var(--radius-xs);
            border: none;
            cursor: pointer;
            font-size: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition);
        }
        .btn-icon .material-symbols-rounded { font-size: 18px; }

        .btn-edit {
            background: var(--blue-light);
            color: var(--blue-dark);
        }
        .btn-edit:hover {
            background: var(--blue);
            color: #fff;
            transform: scale(1.1);
        }
        .btn-del {
            background: var(--red-light);
            color: var(--red);
        }
        .btn-del:hover {
            background: var(--red);
            color: #fff;
            transform: scale(1.1);
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            animation: fadeUp 0.4s ease;
        }
        .empty-state .material-symbols-rounded {
            font-size: 48px;
            color: var(--slate-300);
            margin-bottom: 12px;
        }
        .empty-state p {
            color: var(--slate-400);
            font-size: 0.9rem;
            font-weight: 500;
        }

        .emp-counter {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 14px;
            border-radius: 20px;
            font-size: 0.78rem;
            font-weight: 700;
            background: var(--slate-100);
            color: var(--slate-500);
            margin-right: auto;
        }

        /* ── Toast ── */
        .toast {
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            padding: 14px 28px;
            border-radius: var(--radius-sm);
            font-weight: 700;
            font-size: 0.88rem;
            box-shadow: var(--shadow-lg);
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 10px;
            backdrop-filter: blur(10px);
        }
        .toast.show {
            transform: translateX(-50%) translateY(0);
        }
        .toast.success {
            background: linear-gradient(135deg, #065f46 0%, #047857 100%);
            color: #fff;
        }
        .toast.error {
            background: linear-gradient(135deg, #991b1b 0%, #dc2626 100%);
            color: #fff;
        }
        .toast.info {
            background: linear-gradient(135deg, var(--slate-800) 0%, var(--slate-700) 100%);
            color: #fff;
        }
        .toast .material-symbols-rounded { font-size: 20px; }

        /* ── Confirm Dialog ── */
        .overlay {
            position: fixed; inset: 0;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(4px);
            z-index: 200;
            display: none;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.2s ease;
        }
        .overlay.active { display: flex; }

        .dialog {
            background: #fff;
            border-radius: var(--radius);
            padding: 32px;
            max-width: 360px;
            width: 90%;
            text-align: center;
            box-shadow: var(--shadow-lg);
            animation: popIn 0.3s ease;
        }
        .dialog-icon {
            width: 56px; height: 56px;
            border-radius: 50%;
            background: var(--red-light);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 16px;
        }
        .dialog-icon .material-symbols-rounded { font-size: 28px; color: var(--red); }
        .dialog h3 {
            font-size: 1.1rem;
            font-weight: 800;
            margin-bottom: 8px;
            color: var(--slate-800);
        }
        .dialog p {
            font-size: 0.88rem;
            color: var(--slate-500);
            margin-bottom: 24px;
        }
        .dialog-btns {
            display: flex;
            gap: 10px;
        }
        .dialog-btn {
            flex: 1;
            padding: 12px;
            border-radius: var(--radius-xs);
            border: none;
            font-family: 'Heebo', sans-serif;
            font-size: 0.9rem;
            font-weight: 700;
            cursor: pointer;
            transition: all var(--transition);
        }
        .dialog-btn.cancel {
            background: var(--slate-100);
            color: var(--slate-600);
        }
        .dialog-btn.cancel:hover { background: var(--slate-200); }
        .dialog-btn.confirm {
            background: var(--red);
            color: #fff;
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        }
        .dialog-btn.confirm:hover { background: #dc2626; }

        /* ── Animations ── */
        @keyframes fadeUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes fadeDown {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes popIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-6px); }
            50% { transform: translateX(6px); }
            75% { transform: translateX(-6px); }
        }

        .shake { animation: shake 0.4s ease; }

        /* ── Responsive ── */
        @media (max-width: 700px) {
            body { padding: 12px 8px 80px; }
            h1 { font-size: 1.5rem; }
            .card { padding: 18px 14px; margin-bottom: 16px; }
            .card-header { margin-bottom: 14px; }
            .days-grid { grid-template-columns: repeat(4, 1fr); gap: 6px; }
            .shift-btn { padding: 8px 0; font-size: 0.7rem; }
            .day-label { font-size: 0.72rem; padding: 6px 0; }
            td, thead th { padding: 10px 4px; font-size: 0.75rem; }
            .name-tag { font-size: 0.65rem; padding: 3px 8px; }
            .emp-card { padding: 12px 14px; gap: 10px; }
            .emp-avatar { width: 34px; height: 34px; font-size: 0.8rem; }
            .emp-shifts { gap: 3px; }
            .emp-shift-tag { font-size: 0.6rem; padding: 2px 7px; }
            .header-icon { width: 44px; height: 44px; }
            .header-icon .material-symbols-rounded { font-size: 22px; }
            .form-row { flex-direction: column; align-items: stretch; gap: 6px; }
            .form-row label { min-width: unset; }
        }

        @media (max-width: 380px) {
            .days-grid { grid-template-columns: repeat(3, 1fr); }
        }
    </style>
</head>
<body>
<div class="container">

    <!-- Header -->
    <div class="header">
        <div class="header-icon">
            <span class="material-symbols-rounded">calendar_month</span>
        </div>
        <h1>לוח משמרות</h1>
        <div class="header-sub">ניהול וחלוקת משמרות שבועית</div>
        <div class="sync-badge" id="syncBadge">
            <span class="material-symbols-rounded" style="font-size:14px">cloud_done</span>
            מסונכרן
        </div>
    </div>

    <!-- Schedule Table -->
    <div class="card" style="animation-delay:0.1s">
        <div class="card-header">
            <div class="card-icon blue">
                <span class="material-symbols-rounded">table_chart</span>
            </div>
            <h2>לוח שבועי<small>חלוקת עובדים למשמרות</small></h2>
        </div>

        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th></th>
                        <th>ראשון</th><th>שני</th><th>שלישי</th>
                        <th>רביעי</th><th>חמישי</th><th>שישי</th><th>שבת</th>
                    </tr>
                </thead>
                <tbody id="body"></tbody>
            </table>
        </div>

        <div class="legend">
            <div class="legend-item">
                <div class="legend-dot morning"></div>
                בוקר (10:00–16:00)
            </div>
            <div class="legend-item">
                <div class="legend-dot evening"></div>
                ערב (16:00–22:00)
            </div>
        </div>

        <div class="table-actions">
            <button class="build-btn" onclick="rebuildAndRender()">
                <span class="material-symbols-rounded">autorenew</span>
                חלק משמרות מחדש
            </button>
            <button class="pdf-btn" onclick="exportPDF()">
                <span class="material-symbols-rounded">picture_as_pdf</span>
                ייצוא ל-PDF
            </button>
            <button class="reset-btn" onclick="confirmResetAll()">
                <span class="material-symbols-rounded">restart_alt</span>
                איפוס הכל
            </button>
        </div>
    </div>

    <!-- Add Employee Form -->
    <div class="card form-section" style="animation-delay:0.2s">
        <div class="card-header">
            <div class="card-icon green" id="formIcon">
                <span class="material-symbols-rounded" id="formIconSymbol">person_add</span>
            </div>
            <h2 id="formTitle">הוספת עובד/ת<small id="formSub">הזן שם ובחר משמרות זמינות</small></h2>
        </div>

        <div class="form-row">
            <label>שם:</label>
            <div class="input-wrap">
                <span class="input-icon"><span class="material-symbols-rounded">badge</span></span>
                <input type="text" id="nameInput" placeholder="הכנס שם עובד/ת...">
            </div>
        </div>

        <div class="days-grid" id="daysGrid"></div>

        <button class="submit-btn" id="submitBtn" onclick="addEmployee()">
            <span class="material-symbols-rounded" id="submitIcon">add_circle</span>
            <span id="submitText">הוסף לטבלה</span>
        </button>
        <button class="cancel-btn" id="cancelBtn" onclick="resetForm()">
            <span class="material-symbols-rounded">close</span>
            ביטול עריכה
        </button>
    </div>

    <!-- Employee List -->
    <div class="card" style="animation-delay:0.3s">
        <div class="card-header">
            <div class="card-icon purple">
                <span class="material-symbols-rounded">groups</span>
            </div>
            <h2>ניהול עובדים<small>רשימת עובדים ומשמרות</small></h2>
            <div class="emp-counter" id="empCounter">
                <span class="material-symbols-rounded" style="font-size:16px">person</span>
                <span id="empCountText">0 עובדים</span>
            </div>
        </div>
        <div id="empList"></div>
    </div>

    <div style="text-align:center; color:var(--slate-400); font-size:0.8rem; font-weight:500; margin-top:20px; padding-bottom:8px;">
        הערות: בוקר מקס׳ 3 עובדים · ערב מקס׳ 4 עובדים
    </div>
</div>

<!-- Confirm Dialog -->
<div class="overlay" id="confirmOverlay">
    <div class="dialog">
        <div class="dialog-icon">
            <span class="material-symbols-rounded">delete_forever</span>
        </div>
        <h3 id="confirmTitle">מחיקת עובד</h3>
        <p id="confirmMsg">האם למחוק את העובד?</p>
        <div class="dialog-btns">
            <button class="dialog-btn cancel" onclick="closeConfirm()">ביטול</button>
            <button class="dialog-btn confirm" id="confirmAction">מחק</button>
        </div>
    </div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<script>
const DAYS = ['ראשון','שני','שלישי','רביעי','חמישי','שישי','שבת'];
const DAY_SHORT = { ראשון:'א׳', שני:'ב׳', שלישי:'ג׳', רביעי:'ד׳', חמישי:'ה׳', שישי:'ו׳', שבת:'ש׳' };

const SYNC_URL = 'https://shift-board-sync.nirhemofitness.workers.dev/data';
let syncInProgress = false;
let localVersion = 0;

let data = loadData();
let editIndex = -1;

const formState = {};
DAYS.forEach(d => formState[d] = { m: false, e: false });

const MAX_MORNING = 3;
const MAX_EVENING = 4;

function saveData() {
    localVersion = Date.now();
    try {
        localStorage.setItem('shiftData', JSON.stringify(data));
        localStorage.setItem('shiftVersion', String(localVersion));
    } catch(e) {}
    syncToCloud();
}

function loadData() {
    try {
        localVersion = parseInt(localStorage.getItem('shiftVersion')) || 0;
        const saved = localStorage.getItem('shiftData');
        return saved ? JSON.parse(saved) : [];
    } catch(e) { return []; }
}

async function syncToCloud() {
    if (syncInProgress) return;
    syncInProgress = true;
    try {
        const badge = document.getElementById('syncBadge');
        if (badge) { badge.innerHTML = '<span class="material-symbols-rounded" style="font-size:14px">cloud_upload</span> מסנכרן...'; }
        await fetch(SYNC_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ data, version: localVersion })
        });
        if (badge) { badge.innerHTML = '<span class="material-symbols-rounded" style="font-size:14px">cloud_done</span> מסונכרן'; }
    } catch(e) {
        const badge = document.getElementById('syncBadge');
        if (badge) { badge.innerHTML = '<span class="material-symbols-rounded" style="font-size:14px">cloud_off</span> לא מחובר'; }
    }
    syncInProgress = false;
}

async function loadFromCloud() {
    try {
        const res = await fetch(SYNC_URL);
        if (!res.ok) return;
        const cloud = await res.json();
        const cloudVersion = cloud.version || 0;
        const cloudData = Array.isArray(cloud.data) ? cloud.data : [];

        if (cloudVersion > localVersion) {
            const localStr = JSON.stringify(data);
            const cloudStr = JSON.stringify(cloudData);
            if (localStr !== cloudStr) {
                data = cloudData;
                localVersion = cloudVersion;
                try {
                    localStorage.setItem('shiftData', JSON.stringify(data));
                    localStorage.setItem('shiftVersion', String(localVersion));
                } catch(e) {}
                renderTable();
                renderEmployees();
                showToast('נתונים סונכרנו מהענן', 'info');
            }
        } else if (cloudVersion < localVersion) {
            syncToCloud();
        }
    } catch(e) {}
}

setInterval(loadFromCloud, 5000);

function shuffle(arr) {
    for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
}

let lastSchedule = null;

function buildSchedule() {
    const morning = {}, evening = {}, overflow = {};
    DAYS.forEach(d => {
        const onlyM = [], onlyE = [], both = [];
        data.forEach(p => {
            const hasM = p.m[d] === 1;
            const hasE = p.e[d] === 1;
            if (hasM && hasE) both.push(p.name);
            else if (hasM) onlyM.push(p.name);
            else if (hasE) onlyE.push(p.name);
        });

        morning[d] = [];
        evening[d] = [];
        overflow[d] = [];

        onlyM.forEach(name => {
            if (morning[d].length < MAX_MORNING) morning[d].push(name);
            else overflow[d].push({ name, shift: 'm' });
        });

        onlyE.forEach(name => {
            if (evening[d].length < MAX_EVENING) evening[d].push(name);
            else overflow[d].push({ name, shift: 'e' });
        });

        shuffle(both);
        both.forEach(name => {
            const mFull = morning[d].length >= MAX_MORNING;
            const eFull = evening[d].length >= MAX_EVENING;
            if (mFull && eFull) { overflow[d].push({ name, shift: 'both' }); return; }
            if (mFull) { evening[d].push(name); return; }
            if (eFull) { morning[d].push(name); return; }
            if (Math.random() < 0.5) morning[d].push(name);
            else evening[d].push(name);
        });
    });
    lastSchedule = { morning, evening, overflow };
    return lastSchedule;
}

function renderTable() {
    const tbody = document.getElementById('body');
    const { morning, evening } = buildSchedule();

    let html = `<tr class="row-morning"><td>
        <div class="shift-label">
            <span class="shift-label-title morning">בוקר</span>
            <span class="shift-label-time">10:00–16:00</span>
            <span class="shift-label-max">מקס׳ ${MAX_MORNING}</span>
        </div></td>`;

    DAYS.forEach(d => {
        const n = morning[d];
        html += n.length
            ? '<td><div class="names-cell">' + n.map(x => `<span class="name-tag name-tag-m">${x}</span>`).join('') + '</div></td>'
            : '<td><span class="empty-cell">—</span></td>';
    });

    html += `</tr><tr class="row-evening"><td>
        <div class="shift-label">
            <span class="shift-label-title evening">ערב</span>
            <span class="shift-label-time">16:00–22:00</span>
            <span class="shift-label-max">מקס׳ ${MAX_EVENING}</span>
        </div></td>`;

    DAYS.forEach(d => {
        const n = evening[d];
        html += n.length
            ? '<td><div class="names-cell">' + n.map(x => `<span class="name-tag name-tag-e">${x}</span>`).join('') + '</div></td>'
            : '<td><span class="empty-cell">—</span></td>';
    });
    html += '</tr>';
    tbody.innerHTML = html;
}

function renderEmployees() {
    const el = document.getElementById('empList');
    const countEl = document.getElementById('empCountText');
    countEl.textContent = `${data.length} עובדים`;

    if (!data.length) {
        el.innerHTML = `<div class="empty-state">
            <span class="material-symbols-rounded">person_off</span>
            <p>אין עובדים עדיין – הוסף עובדים מהטופס למעלה</p>
        </div>`;
        return;
    }

    const overflowByName = {};
    if (lastSchedule && lastSchedule.overflow) {
        DAYS.forEach(d => {
            (lastSchedule.overflow[d] || []).forEach(item => {
                if (!overflowByName[item.name]) overflowByName[item.name] = [];
                const label = item.shift === 'both' ? 'בוקר/ערב' : (item.shift === 'm' ? 'בוקר' : 'ערב');
                overflowByName[item.name].push({ day: DAY_SHORT[d], label });
            });
        });
    }

    let html = '<div class="emp-list">';
    data.forEach((p, i) => {
        let mCount = 0, eCount = 0;
        const tags = [];
        DAYS.forEach(d => {
            if (p.m[d] === 1) { mCount++; tags.push(`<span class="emp-shift-tag m">${DAY_SHORT[d]} בוקר</span>`); }
            if (p.e[d] === 1) { eCount++; tags.push(`<span class="emp-shift-tag e">${DAY_SHORT[d]} ערב</span>`); }
        });

        const overflowTags = (overflowByName[p.name] || []).map(
            o => `<span class="emp-shift-tag overflow">${o.day} ${o.label} (מלא)</span>`
        ).join('');

        const total = mCount + eCount;
        const initial = p.name.charAt(0);

        html += `<div class="emp-card">
            <div class="emp-avatar">${initial}</div>
            <div class="emp-info">
                <div class="emp-name">${p.name}</div>
                <div class="emp-meta">
                    <span class="emp-badge">${total} משמרות</span>
                    <span>${mCount} בוקר · ${eCount} ערב</span>
                </div>
            </div>
            <div class="emp-shifts">${tags.join('')}${overflowTags}</div>
            <div class="emp-actions">
                <button class="btn-icon btn-edit" onclick="editEmployee(${i})" title="עריכה">
                    <span class="material-symbols-rounded">edit</span>
                </button>
                <button class="btn-icon btn-del" onclick="confirmDelete(${i})" title="מחיקה">
                    <span class="material-symbols-rounded">delete</span>
                </button>
            </div>
        </div>`;
    });
    html += '</div>';
    el.innerHTML = html;
}

function buildForm() {
    const grid = document.getElementById('daysGrid');
    let html = '';
    DAYS.forEach(d => {
        html += `<div class="day-col">
            <div class="day-label">${d}</div>
            <div class="shift-btns">
                <button class="shift-btn" id="btn-m-${d}" onclick="toggleShift('${d}','m',this)">בוקר</button>
                <button class="shift-btn" id="btn-e-${d}" onclick="toggleShift('${d}','e',this)">ערב</button>
            </div>
        </div>`;
    });
    grid.innerHTML = html;
}

function toggleShift(day, type, btn) {
    formState[day][type] = !formState[day][type];
    btn.classList.toggle(type === 'm' ? 'active-m' : 'active-e', formState[day][type]);
}

function showToast(msg, type = 'info') {
    const t = document.getElementById('toast');
    t.className = 'toast ' + type;

    let icon = 'info';
    if (type === 'success') icon = 'check_circle';
    else if (type === 'error') icon = 'error';

    t.innerHTML = `<span class="material-symbols-rounded">${icon}</span> ${msg}`;
    requestAnimationFrame(() => t.classList.add('show'));
    setTimeout(() => t.classList.remove('show'), 2800);
}

function resetForm() {
    document.getElementById('nameInput').value = '';
    DAYS.forEach(d => {
        formState[d] = { m: false, e: false };
        document.getElementById('btn-m-' + d).classList.remove('active-m');
        document.getElementById('btn-e-' + d).classList.remove('active-e');
    });
    editIndex = -1;
    document.getElementById('formTitle').innerHTML = 'הוספת עובד/ת<small>הזן שם ובחר משמרות זמינות</small>';
    document.getElementById('submitText').textContent = 'הוסף לטבלה';
    document.getElementById('submitIcon').textContent = 'add_circle';
    document.getElementById('submitBtn').classList.remove('edit-mode');
    document.getElementById('cancelBtn').classList.remove('visible');
    document.getElementById('nameInput').disabled = false;
    document.getElementById('formIcon').classList.remove('purple');
    document.getElementById('formIcon').classList.add('green');
    document.getElementById('formIconSymbol').textContent = 'person_add';
}

function loadToForm(p) {
    document.getElementById('nameInput').value = p.name;
    DAYS.forEach(d => {
        formState[d].m = p.m[d] === 1;
        formState[d].e = p.e[d] === 1;
        document.getElementById('btn-m-' + d).classList.toggle('active-m', formState[d].m);
        document.getElementById('btn-e-' + d).classList.toggle('active-e', formState[d].e);
    });
}

function editEmployee(idx) {
    editIndex = idx;
    loadToForm(data[idx]);
    document.getElementById('formTitle').innerHTML = `עריכת ${data[idx].name}<small>שנה משמרות ולחץ שמור</small>`;
    document.getElementById('submitText').textContent = 'שמור שינויים';
    document.getElementById('submitIcon').textContent = 'save';
    document.getElementById('submitBtn').classList.add('edit-mode');
    document.getElementById('cancelBtn').classList.add('visible');
    document.getElementById('nameInput').disabled = true;
    document.getElementById('formIcon').classList.remove('green');
    document.getElementById('formIcon').classList.add('purple');
    document.getElementById('formIconSymbol').textContent = 'edit_note';
    window.scrollTo({ top: document.getElementById('formTitle').offsetTop - 20, behavior: 'smooth' });
}

let pendingDeleteIdx = -1;

function confirmDelete(idx) {
    pendingDeleteIdx = idx;
    const name = data[idx].name;
    document.getElementById('confirmTitle').textContent = `מחיקת ${name}`;
    document.getElementById('confirmMsg').textContent = `האם אתה בטוח שברצונך למחוק את ${name}? פעולה זו לא ניתנת לביטול.`;
    document.getElementById('confirmOverlay').classList.add('active');
    document.getElementById('confirmAction').onclick = () => executeDelete();
}

function closeConfirm() {
    document.getElementById('confirmOverlay').classList.remove('active');
    pendingDeleteIdx = -1;
}

function executeDelete() {
    if (pendingDeleteIdx < 0) return;
    const name = data[pendingDeleteIdx].name;
    data.splice(pendingDeleteIdx, 1);
    saveData();
    if (editIndex === pendingDeleteIdx) resetForm();
    else if (editIndex > pendingDeleteIdx) editIndex--;
    renderTable();
    renderEmployees();
    closeConfirm();
    showToast(`${name} הוסר בהצלחה`, 'success');
}

function addEmployee() {
    const nameInput = document.getElementById('nameInput');
    const name = nameInput.value.trim();

    if (!name) {
        nameInput.parentElement.classList.add('shake');
        setTimeout(() => nameInput.parentElement.classList.remove('shake'), 400);
        showToast('יש להכניס שם', 'error');
        return;
    }

    const m = {}, e = {};
    let hasAny = false;
    DAYS.forEach(d => {
        if (formState[d].m) { m[d] = 1; hasAny = true; }
        if (formState[d].e) { e[d] = 1; hasAny = true; }
    });

    if (!hasAny) {
        document.getElementById('daysGrid').classList.add('shake');
        setTimeout(() => document.getElementById('daysGrid').classList.remove('shake'), 400);
        showToast('יש לבחור לפחות משמרת אחת', 'error');
        return;
    }

    if (editIndex >= 0) {
        data[editIndex].m = m;
        data[editIndex].e = e;
        showToast(`${name} עודכן בהצלחה!`, 'success');
    } else {
        if (data.find(p => p.name === name)) {
            showToast('שם זה כבר קיים – לחץ עריכה כדי לשנות', 'error');
            return;
        }
        data.push({ name, m, e });
        showToast(`${name} נוסף בהצלחה!`, 'success');
    }

    saveData();
    renderTable();
    renderEmployees();
    resetForm();
}

function rebuildAndRender() {
    renderTable();
    showToast('המשמרות חולקו מחדש', 'info');
}

function exportPDF() {
    const { morning, evening } = buildSchedule();

    const wrapper = document.createElement('div');
    wrapper.style.cssText = 'direction:rtl; padding:24px; font-family:Heebo,Arial,sans-serif; background:#fff;';

    wrapper.innerHTML = `
        <h2 style="text-align:center; margin-bottom:20px; font-size:1.6rem; font-weight:900; color:#1e293b; letter-spacing:1px;">
            לוח משמרות שבועי
        </h2>
        <table style="width:100%; border-collapse:collapse; border:2px solid #1e293b; direction:rtl;">
            <thead>
                <tr>
                    <th style="background:#1e293b; color:#fff; padding:12px 10px; font-size:0.9rem; font-weight:700; text-align:right; border:1px solid #334155; width:80px;"></th>
                    ${DAYS.map(d => `<th style="background:#1e293b; color:#fff; padding:12px 6px; font-size:0.9rem; font-weight:700; text-align:center; border:1px solid #334155;">${d}</th>`).join('')}
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td style="padding:14px 10px; text-align:right; font-weight:800; font-size:0.95rem; color:#2563eb; background:#eff6ff; border:1px solid #d0d5e0; vertical-align:middle;">
                        בוקר
                    </td>
                    ${DAYS.map(d => {
                        const names = morning[d] || [];
                        return `<td style="padding:10px 6px; text-align:center; vertical-align:top; background:#eff6ff; border:1px solid #d0d5e0;">
                            ${names.length ? names.map(n => `<div style="display:inline-block; background:#2563eb; color:#fff; padding:3px 10px; border-radius:12px; font-size:0.75rem; font-weight:700; margin:2px;">${n}</div>`).join('') : '<span style="color:#ccc;">—</span>'}
                        </td>`;
                    }).join('')}
                </tr>
                <tr>
                    <td style="padding:14px 10px; text-align:right; font-weight:800; font-size:0.95rem; color:#7c3aed; background:#f5f3ff; border:1px solid #d0d5e0; vertical-align:middle;">
                        ערב
                    </td>
                    ${DAYS.map(d => {
                        const names = evening[d] || [];
                        return `<td style="padding:10px 6px; text-align:center; vertical-align:top; background:#f5f3ff; border:1px solid #d0d5e0;">
                            ${names.length ? names.map(n => `<div style="display:inline-block; background:#7c3aed; color:#fff; padding:3px 10px; border-radius:12px; font-size:0.75rem; font-weight:700; margin:2px;">${n}</div>`).join('') : '<span style="color:#ccc;">—</span>'}
                        </td>`;
                    }).join('')}
                </tr>
            </tbody>
        </table>
        <div style="display:flex; justify-content:center; gap:24px; margin-top:14px; font-size:0.8rem; color:#64748b; font-weight:600;">
            <span>⬤ <span style="color:#2563eb;">בוקר</span> 10:00–16:00</span>
            <span>⬤ <span style="color:#7c3aed;">ערב</span> 16:00–22:00</span>
        </div>
        <div style="text-align:center; color:#94a3b8; font-size:0.78rem; font-weight:500; margin-top:10px;">
            הערות: בוקר מקס׳ ${MAX_MORNING} עובדים · ערב מקס׳ ${MAX_EVENING} עובדים
        </div>
    `;

    document.body.appendChild(wrapper);

    const opt = {
        margin: 10,
        filename: 'shift-schedule.pdf',
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2, useCORS: true, scrollY: 0, logging: false },
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'landscape' }
    };

    showToast('מייצא PDF...', 'info');
    html2pdf().set(opt).from(wrapper).save().then(() => {
        document.body.removeChild(wrapper);
        showToast('PDF יוצא בהצלחה!', 'success');
    }).catch(() => {
        document.body.removeChild(wrapper);
        showToast('שגיאה בייצוא', 'error');
    });
}

function confirmResetAll() {
    document.getElementById('confirmTitle').textContent = 'איפוס כל הנתונים';
    document.getElementById('confirmMsg').textContent = 'האם אתה בטוח שברצונך למחוק את כל העובדים והנתונים? פעולה זו לא ניתנת לביטול.';
    document.getElementById('confirmOverlay').classList.add('active');
    document.getElementById('confirmAction').onclick = () => executeResetAll();
}

function executeResetAll() {
    data = [];
    saveData();
    resetForm();
    renderTable();
    renderEmployees();
    closeConfirm();
    showToast('כל הנתונים אופסו בהצלחה', 'success');
}

document.getElementById('nameInput').addEventListener('keydown', ev => {
    if (ev.key === 'Enter') addEmployee();
});

document.getElementById('confirmOverlay').addEventListener('click', e => {
    if (e.target === e.currentTarget) closeConfirm();
});

renderTable();
renderEmployees();
buildForm();
loadFromCloud();
</script>
</body>
</html>
